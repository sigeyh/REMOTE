import 'package:flutter/material.dart';
import 'package:web_socket_channel/web_socket_channel.dart';

void main() => runApp(SamsungRemoteApp());

class SamsungRemoteApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Samsung Remote',
      theme: ThemeData(primarySwatch: Colors.deepPurple),
      home: RemoteControlScreen(),
    );
  }
}

class RemoteControlScreen extends StatefulWidget {
  @override
  _RemoteControlScreenState createState() => _RemoteControlScreenState();
}

class _RemoteControlScreenState extends State<RemoteControlScreen> {
  TextEditingController ipController = TextEditingController();
  WebSocketChannel? channel;

  final Map<String, String> remoteKeys = {
    'Power': 'KEY_POWER',
    'Vol +': 'KEY_VOLUP',
    'Vol -': 'KEY_VOLDOWN',
    'Up': 'KEY_UP',
    'Down': 'KEY_DOWN',
    'Left': 'KEY_LEFT',
    'Right': 'KEY_RIGHT',
    'OK': 'KEY_ENTER',
    'Back': 'KEY_RETURN',
  };

  void connectToTV(String ip) {
    final uri = 'ws://$ip:8001/api/v2/channels/samsung.remote.control?name=U2Ftc3VuZ1JlbW90ZQ==';
    channel = WebSocketChannel.connect(Uri.parse(uri));

    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text('Connected to $ip')),
    );
  }

  void sendKey(String key) {
    if (channel != null) {
      final msg = {
        'method': 'ms.remote.control',
        'params': {
          'Cmd': 'Click',
          'DataOfCmd': key,
          'Option': 'false',
          'TypeOfRemote': 'SendRemoteKey'
        }
      };
      channel!.sink.add(msg.toString());
    }
  }

  @override
  void dispose() {
    channel?.sink.close();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Samsung TV Remote')),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          children: [
            TextField(
              controller: ipController,
              decoration: InputDecoration(
                labelText: 'Enter TV IP Address',
                suffixIcon: IconButton(
                  icon: Icon(Icons.connect_without_contact),
                  onPressed: () => connectToTV(ipController.text.trim()),
                ),
              ),
              keyboardType: TextInputType.number,
            ),
            const SizedBox(height: 20),
            Expanded(
              child: GridView.count(
                crossAxisCount: 3,
                childAspectRatio: 1.4,
                crossAxisSpacing: 10,
                mainAxisSpacing: 10,
                children: remoteKeys.entries.map((entry) {
                  return ElevatedButton(
                    onPressed: () => sendKey(entry.value),
                    child: Text(entry.key, textAlign: TextAlign.center),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.deepPurple[300],
                      textStyle: TextStyle(fontSize: 16),
                    ),
                  );
                }).toList(),
              ),
            ),
          ],
        ),
      ),
    );
  }
}
